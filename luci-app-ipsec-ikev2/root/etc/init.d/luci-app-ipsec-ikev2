#!/bin/sh /etc/rc.common

USE_PROCD=1
START=96
STOP=10

NAME="luci-app-ipsec-ikev2"
CFG="luci-app-ipsec-ikev2"
GEN="/usr/libexec/ipsec-ikev2/genconfig.sh"

start_service() {
    if ! "$GEN"; then
        echo "$NAME: failed to generate swanctl.conf"
        return 1
    fi
    /etc/init.d/strongswan enable >/dev/null 2>&1
    /etc/init.d/strongswan start
    swanctl --load-all >/dev/null 2>&1 || true

    procd_open_instance
    procd_set_param command /bin/true
    procd_close_instance
}

stop_service() {
    return 0
}

reload_service() {
    "$GEN" || return 1
    /etc/init.d/strongswan start
    swanctl --load-all >/dev/null 2>&1 || true
    /etc/init.d/firewall reload >/dev/null 2>&1 || true
}

service_triggers() {
    procd_add_reload_trigger "$CFG"
    procd_add_reload_trigger "network" "firewall"
}
