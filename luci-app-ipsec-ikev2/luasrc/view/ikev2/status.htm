<%+header%>
<h2>IKEv2 状态 / 诊断</h2>
<div class="cbi-section">
  <div class="cbi-section-descr">查看当前连接、SA、地址池及环境诊断。</div>

  <h3>运行状态</h3>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("pgrep -fa charon || echo 'charon 未运行'")%></pre>

  <h3>连接与 SA</h3>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("swanctl --list-conns 2>/dev/null")%></pre>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("swanctl --list-sas 2>/dev/null")%></pre>

  <h3>地址池</h3>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("swanctl --list-pools 2>/dev/null")%></pre>

  <h3>防火墙检查（firewall3/iptables）</h3>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("uci show firewall | sed -n 's/\\(.*masq=.*\\)/\\1/p'")%></pre>
  <pre style="white-space:pre-wrap;"><%=luci.sys.exec("iptables -S | grep -E 'policy|udp.*(500|4500)| esp '")%></pre>

  <h3>导出 swanctl.conf</h3>
  <a class="cbi-button cbi-button-action" href="<%=luci.dispatcher.build_url('admin/vpn/ikev2/export')%>">下载 swanctl.conf</a>
</div>
<%+footer%>
